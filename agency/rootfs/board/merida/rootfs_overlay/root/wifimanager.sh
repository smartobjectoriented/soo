#!/bin/bash

FREQUENCIES[1]=2412
FREQUENCIES[2]=2417
FREQUENCIES[3]=2422
FREQUENCIES[4]=2427
FREQUENCIES[5]=2432
FREQUENCIES[6]=2437
FREQUENCIES[7]=2442
FREQUENCIES[8]=2447
FREQUENCIES[9]=2452
FREQUENCIES[10]=2457
FREQUENCIES[11]=2462
FREQUENCIES[12]=2467
FREQUENCIES[13]=2472
FREQUENCIES[14]=2484
FREQUENCIES[36]=5180
FREQUENCIES[40]=5200
FREQUENCIES[44]=5220
FREQUENCIES[48]=5240
FREQUENCIES[52]=5260
FREQUENCIES[56]=5280
FREQUENCIES[60]=5300
FREQUENCIES[64]=5320
FREQUENCIES[100]=5500
FREQUENCIES[104]=5520
FREQUENCIES[108]=5540
FREQUENCIES[112]=5560
FREQUENCIES[116]=5580
FREQUENCIES[120]=5600
FREQUENCIES[124]=5620
FREQUENCIES[128]=5640
FREQUENCIES[132]=5660
FREQUENCIES[136]=5680
FREQUENCIES[140]=5700
FREQUENCIES[144]=5720
FREQUENCIES[149]=5745
FREQUENCIES[153]=5765
FREQUENCIES[157]=5785
FREQUENCIES[161]=5805
FREQUENCIES[165]=5825

DEFAULT_CHANNEL=36
DEFAULT_BANDWIDTH="HT40+"
DEFAULT_SSID="soo-wifi"

if [[ -f ${SOO_CONF_FILE} ]]
then
    source ${SOO_CONF_FILE}
fi

if [[ -n ${WIFI_SSID} ]]
then
    SSID=${WIFI_SSID}
else
    SSID=${DEFAULT_SSID}
fi

if [[ -n ${WIFI_CHANNEL} && -n ${FREQUENCIES[${WIFI_CHANNEL}]} ]]
then
    FREQUENCY=${FREQUENCIES[${WIFI_CHANNEL}]}
else
    FREQUENCY=${FREQUENCIES[${DEFAULT_CHANNEL}]}
fi

if [[ -n ${WIFI_BANDWIDTH} ]]
then
    BANDWIDTH=${WIFI_BANDWIDTH}
else
    BANDWIDTH=${DEFAULT_BANDWIDTH}
fi

iw reg set CH
iw mlan0 set type ibss
sleep 2
ifconfig mlan0 up
sleep 2
iw mlan0 ibss join ${SSID} ${FREQUENCY} ${BANDWIDTH}
