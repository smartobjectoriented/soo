<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3.2. vuihandler driver &mdash; Smart Object Oriented 2021.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/style.css" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=7751120a" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/documentation_options.js?v=b4aaf8b5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.3. vwagoled" href="vwagoled.html" />
    <link rel="prev" title="3.1. vdummy driver" href="vdummy.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Smart Object Oriented
          </a>
              <div class="version">
                2021.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/architecture.html">2. SOO Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="drivers.html">3. Frontend &amp; backend drivers</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="vdummy.html">3.1. <em>vdummy</em> driver</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3.2. vuihandler driver</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">3.2.1. Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#features-and-characteristics">3.2.2. Features and characteristics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#functional-description">3.2.3. Functional description</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#general-architecture">3.2.3.1. General architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#userspace-bluetooth-server">3.2.3.2. Userspace Bluetooth server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vuihandler-packet">3.2.3.3. vuiHandler packet</a></li>
<li class="toctree-l4"><a class="reference internal" href="#frontend">3.2.3.4. Frontend</a></li>
<li class="toctree-l4"><a class="reference internal" href="#backend">3.2.3.5. Backend</a></li>
<li class="toctree-l4"><a class="reference internal" href="#external-interfaces">3.2.3.6. External interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="#future-work-improvements">3.2.3.7. Future work/Improvements</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="vwagoled.html">3.3. vwagoled</a></li>
<li class="toctree-l2"><a class="reference internal" href="venocean.html">3.4. EnOcean</a></li>
<li class="toctree-l2"><a class="reference internal" href="vlora.html">3.5. LoRa</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rootfs/rootfs.html">4. User applications and rootfs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html">5. User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logging.html">6. Logging facility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logging.html#enabling-initcall-logging">7. Enabling <code class="docutils literal notranslate"><span class="pre">initcall</span></code> logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../board_issues.html">8. Board related issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aarch64.html">9. Configuration for AArch64 64-bit architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_flow.html">10. Development  flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">11. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ME/ME.html">12. Mobile Entities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../demos/demos.html">13. Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coding_conventions.html">14. Coding conventions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Smart Object Oriented</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="drivers.html"><span class="section-number">3. </span>Frontend &amp; backend drivers</a></li>
      <li class="breadcrumb-item active"><span class="section-number">3.2. </span>vuihandler driver</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="vuihandler-driver">
<span id="vuihandler"></span><h1><span class="section-number">3.2. </span>vuihandler driver<a class="headerlink" href="#vuihandler-driver" title="Link to this heading">¶</a></h1>
<section id="introduction">
<h2><span class="section-number">3.2.1. </span>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p><em>must be updated…</em></p>
<p>The vUIHandler interface allows a ME to communicate with a Bluetooth device like a tablet or a smartphone.
It relies on the RFCOMM protocol and uses the TTY serial port to transmit the data to the BT adapter.</p>
<p>Associated dev capabilities:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Devcaps class</p></th>
<th class="head"><p>Devcaps</p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><em>DEVCAPS_CLASS_COM</em></p></td>
<td><p><em>DEVCAP_COMM_UIHANDLER</em></p></td>
<td><p>Enabled with a tablet UI application is connected</p></td>
</tr>
</tbody>
</table>
<p>Only one dev capability in the list below can be set at a time</p>
</section>
<section id="features-and-characteristics">
<h2><span class="section-number">3.2.2. </span>Features and characteristics<a class="headerlink" href="#features-and-characteristics" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>vUIHandler allows the bi-directional communication using the RFCOMM protocol over the Bluetooth interface, providing a PAN service over BT, between a tablet (or smartphone) and a Smart Object.</p></li>
<li><p>vUIHandler is a non-realtime driver as no realtime constraints are required.</p></li>
<li><p>At most one vUIHandler frontend per ME providing one TX+RX channel.</p></li>
<li><p>The remote application targets one ME by setting the target ME SPID in the packet it sends. vUIHandler is responsible of the dispatching among the MEs.</p></li>
<li><dl class="simple">
<dt>If several MEs have an access to the vUIHandler interface, there is no priority control among the MEs. In addition:</dt><dd><ul>
<li><p>Any TX request coming from any ME will be processed without distinction.</p></li>
<li><p>Any RX request will be forwarded to the ME targeted by the incoming packet.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Maximal packet size: see Section 3.5.</p></li>
<li><p>vUIHandler can also be used without targeting any ME. As it is the main entry point for any Bluetooth transfer, it is also used to inject a ME using Bluetooth. In that case, the data are further retrieved by the Injector, or any Agency module needing BT access.</p></li>
</ul>
</section>
<section id="functional-description">
<h2><span class="section-number">3.2.3. </span>Functional description<a class="headerlink" href="#functional-description" title="Link to this heading">¶</a></h2>
<section id="general-architecture">
<h3><span class="section-number">3.2.3.1. </span>General architecture<a class="headerlink" href="#general-architecture" title="Link to this heading">¶</a></h3>
<figure class="align-center" id="id7">
<img alt="../_images/SOO_drivers_vuihandler_architecture.png" src="../_images/SOO_drivers_vuihandler_architecture.png" />
<figcaption>
<p><span class="caption-number">Fig. 3.1 </span><span class="caption-text">Architecture and interfaces of the vuihandler</span><a class="headerlink" href="#id7" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>The vuihandler interface is split in two parts:</p>
<ul class="simple">
<li><p>A backend: used to access SOOlink and the RFCOMM driver. Resides in the agency.</p></li>
<li><p>A frontend: used to send/receive the ME application data to/from the backend.</p></li>
</ul>
<p>The data transfers uses the following structures:</p>
<ul>
<li><p>There are two shared rings (circular buffers) per ME:</p>
<blockquote>
<div><ul class="simple">
<li><p>tx_ring is dedicated to the TX path, from the ME to the remote device.</p></li>
<li><p>rx_ring is dedicated to the RX path, from the remote device to the ME.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>There are two shared buffers per ME to store the outgoing and incoming packets:</p>
<blockquote>
<div><ul class="simple">
<li><p>One shared buffer is dedicated to the TX path.</p></li>
<li><p>One shared buffer is dedicated to the RX path.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>There is a TX buffer used to queue TX packets in the backend. It is needed as we only have one TX thread and multiple TX sources (agency or MEs). It is implemented as a limited circular buffer.</p></li>
<li><p>Every packet, TX or RX goes through SOOlink before/after being transmitted/received.</p></li>
</ul>
<section id="soolink-paths">
<h4><span class="section-number">3.2.3.1.1. </span>SOOlink paths<a class="headerlink" href="#soolink-paths" title="Link to this heading">¶</a></h4>
<figure class="align-center" id="id8">
<img alt="../_images/SOO_drivers_vuihandler_soolink_path.png" src="../_images/SOO_drivers_vuihandler_soolink_path.png" />
<figcaption>
<p><span class="caption-number">Fig. 3.2 </span><span class="caption-text">Diagram sequence of the RX path from the RFCOMM driver to the vuihandler</span><a class="headerlink" href="#id8" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="userspace-bluetooth-server">
<h3><span class="section-number">3.2.3.2. </span>Userspace Bluetooth server<a class="headerlink" href="#userspace-bluetooth-server" title="Link to this heading">¶</a></h3>
<p>The BT interface consist of a thread running in the agency user space application called during the post-boot init (<em>S51agency</em>), using the <cite>btmanager.sh</cite> script. It opens a RFCOMM socket in raw (TTY) mode. The linux rfcomm module is patched to forward the data to SOOlink instead of the classical path.</p>
<p>In order to prepare the BT adapter, the <cite>btmanager.sh</cite> script does the configuration using the BlueZ tools suite (in perenthesis). This is a high level description of this process:</p>
<ul class="simple">
<li><p>Attach an address to the BT controller and load it firmware (<cite>hciattach</cite>)</p></li>
<li><p>Launch the BT daemon  (<cite>bluetoothd</cite>)</p></li>
<li><p>Configure the controller to avoid having to ask for a PIN during the pairing (<cite>bt-agent</cite>)</p></li>
<li><p>Configure the channel in Serial-Port mode so it uses the TTY interfac (<cite>sdptool</cite>)</p></li>
<li><p>Launch a RFCOMM server which opens a socket and listen to the incoming connections (<cite>rfcomm</cite>)</p></li>
</ul>
</section>
<section id="vuihandler-packet">
<h3><span class="section-number">3.2.3.3. </span>vuiHandler packet<a class="headerlink" href="#vuihandler-packet" title="Link to this heading">¶</a></h3>
<p>As explained before, the vuihandler receive the data from SOOlink as a <cite>vuihandler_pkt_t</cite>. It is structured like this:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Member</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>slotID</p></td>
<td><p>uint32_t</p></td>
<td><p>Corresponding FE ID, used to route the packets to the correct ME</p></td>
</tr>
<tr class="row-odd"><td><p>type</p></td>
<td><p>int8_t</p></td>
<td><p>packet type (see below for values)</p></td>
</tr>
<tr class="row-even"><td><p>payload</p></td>
<td><p>uint8_t *</p></td>
<td><p>Pointer to the packet effective data. The content depend of the type.</p></td>
</tr>
</tbody>
</table>
<p>In term of memory, the payload content is directly encoded after the type.</p>
<section id="packet-types">
<h4><span class="section-number">3.2.3.3.1. </span>Packet types<a class="headerlink" href="#packet-types" title="Link to this heading">¶</a></h4>
<p>The table below lists the different vuihandler packet types:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>VUIHANDLER_BEACON</p></td>
<td><p>Not used</p></td>
</tr>
<tr class="row-odd"><td><p>VUIHANDLER_DATA</p></td>
<td><p>Not used</p></td>
</tr>
<tr class="row-even"><td><p>The packet contains a chunk of the ME to be injected. Routed to the injector.</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>VUIHANDLER_ME_SIZE*</p></td>
<td><p>The packet contains size of the ME to be injected. Routed to the injector</p></td>
</tr>
<tr class="row-even"><td><p>VUIHANDLER_ASK_LIST*</p></td>
<td><p>Ask the agency to send the XML ME list.</p></td>
</tr>
<tr class="row-odd"><td><p>VUIHANDLER_POST</p></td>
<td><p>Specify that the packet contains an event data to be forwarded to the ME.</p></td>
</tr>
<tr class="row-even"><td><p>VUIHANDLER_SELECT</p></td>
<td><p>Specify a ME to be selected by the tablet. The ME will then send its XML UI model.</p></td>
</tr>
<tr class="row-odd"><td><p>VUIHANDLER_SEND</p></td>
<td><p>The packet contains an event to be handled by a ME</p></td>
</tr>
</tbody>
</table>
<p>The type marked with a <strong>*</strong> are destinated to the Agency. The other ones are destinated to a ME.</p>
</section>
</section>
<section id="frontend">
<h3><span class="section-number">3.2.3.4. </span>Frontend<a class="headerlink" href="#frontend" title="Link to this heading">¶</a></h3>
<p>The frontend (FE) is directly used by the client, which is the ME application that wants to communicate with the remote device.</p>
<section id="data-structures">
<h4><span class="section-number">3.2.3.4.1. </span>Data structures<a class="headerlink" href="#data-structures" title="Link to this heading">¶</a></h4>
<p>The frontend handles its data using these structures:</p>
<ul class="simple">
<li><p><cite>vuihandler_t</cite>: Stores the data used to communicate with the BE (rings, buffers, evtchn, …)</p></li>
<li><p><cite>vuihandler_priv_t</cite>: Private driver data. Wrapper around <cite>vuihandler_t</cite>, which also stores data used to monitor and handle the state of the FE.</p></li>
</ul>
</section>
<section id="init">
<h4><span class="section-number">3.2.3.4.2. </span>Init<a class="headerlink" href="#init" title="Link to this heading">¶</a></h4>
<p>Allocate the private data structure. Initialize the FE boilerplate.</p>
</section>
<section id="probe">
<h4><span class="section-number">3.2.3.4.3. </span>Probe<a class="headerlink" href="#probe" title="Link to this heading">¶</a></h4>
<p>The pages dedicated to the rings and the shared buffers are allocated. The <em>pfns</em> are saved in <em>vbstore</em>. The ring IRQ handlers are registered.</p>
</section>
<section id="connected">
<h4><span class="section-number">3.2.3.4.4. </span>Connected<a class="headerlink" href="#connected" title="Link to this heading">¶</a></h4>
<p>The frontend enters in connected state when the following conditions are met:</p>
<ul class="simple">
<li><p>The shared rings are allocated.</p></li>
<li><p>The shared buffers are allocated.</p></li>
<li><p>The event channels for the rings are ready.</p></li>
</ul>
<p>When connected it does the following:</p>
<ul class="simple">
<li><p>Notify the BE via virq so it can process any pending request</p></li>
<li><p>Start the TX thread</p></li>
</ul>
</section>
<section id="reconfiguring">
<h4><span class="section-number">3.2.3.4.5. </span>Reconfiguring<a class="headerlink" href="#reconfiguring" title="Link to this heading">¶</a></h4>
<p>Does the same as probe.</p>
</section>
<section id="closed">
<h4><span class="section-number">3.2.3.4.6. </span>Closed<a class="headerlink" href="#closed" title="Link to this heading">¶</a></h4>
<p>The inter-domain event channels are un-bound and closed. The shared rings are cleared. The shared buffers are cleared.</p>
</section>
<section id="suspend">
<h4><span class="section-number">3.2.3.4.7. </span>Suspend<a class="headerlink" href="#suspend" title="Link to this heading">¶</a></h4>
<p>Does nothing at the moment.</p>
</section>
<section id="resume">
<h4><span class="section-number">3.2.3.4.8. </span>Resume<a class="headerlink" href="#resume" title="Link to this heading">¶</a></h4>
<p>Does nothing at the moment.</p>
</section>
</section>
<section id="backend">
<h3><span class="section-number">3.2.3.5. </span>Backend<a class="headerlink" href="#backend" title="Link to this heading">¶</a></h3>
<p>The backend (BE) is in the agency.</p>
<section id="id1">
<h4><span class="section-number">3.2.3.5.1. </span>Data structures<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h4>
<p>The backend handles its data and the corresponding FE(s) data using these structures:</p>
<ul class="simple">
<li><p><cite>vuihandler_drv_priv_t</cite>: Private BE structure. Only allocated once per BE. Maintains the BE specific data (completions, rfcomm_pid, …)</p></li>
<li><p><cite>vuihandler_t</cite>: Stores everything related to a specific FE (rings, evtchn, shared_buffer, …)</p></li>
<li><p><cite>vuihandler_priv_t</cite>: Wrapper around the <cite>vuihandler_t</cite> structure. This is the structure registered as private data to the <cite>vbus_device</cite> representing out frontend.</p></li>
<li><p><cite>list_head</cite>: A list to store every <cite>vbus_device</cite> corresponding to the FEs.</p></li>
<li><p><cite>vdrvback_t</cite>: Generic backend descriptor, which specifies the callbacks used by the BE. It also stores the <cite>vuihandler_drv_priv_t</cite> private BE structure as its data.</p></li>
</ul>
</section>
<section id="id2">
<h4><span class="section-number">3.2.3.5.2. </span>Init<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h4>
<p>It does the following:</p>
<ul class="simple">
<li><p>Tells <cite>Device Access</cite> to enable the dev capability <cite>DEVCAP_COMM_UIHANDLER</cite> in class <cite>DEVCAPS_CLASS_COM</cite>.</p></li>
<li><p>Initializes the TX buffers used afterward.</p></li>
<li><p>Register the threads (RX and TX) to the <cite>sooenv</cite> in order to start them when SOOlink is ready.</p></li>
<li><p>Initialize the backend boilerplate.</p></li>
</ul>
</section>
<section id="id3">
<h4><span class="section-number">3.2.3.5.3. </span>probe<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h4>
<p>Called each time a FE connect to the BE.</p>
<p>It does the following:</p>
<ul class="simple">
<li><p>Allocate a structure to maintain the FE state and members.</p></li>
<li><p>Assign the previously allocated structure to the <cite>vbus_device</cite> corresponding to the FE as private data.</p></li>
<li><p>Register the <cite>vbus_device</cite> in its internal list to be able to handle multiple frontends.</p></li>
</ul>
</section>
<section id="remove">
<h4><span class="section-number">3.2.3.5.4. </span>remove<a class="headerlink" href="#remove" title="Link to this heading">¶</a></h4>
<p>Called when a frontend is removed.</p>
<p>It does the opposite of <cite>probe</cite>.</p>
</section>
<section id="id4">
<h4><span class="section-number">3.2.3.5.5. </span>resume<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h4>
<p>Called when a FE is resumed.</p>
<p>Does nothing at the moment.</p>
</section>
<section id="id5">
<h4><span class="section-number">3.2.3.5.6. </span>suspend<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h4>
<p>Called when a FE is suspended.</p>
<p>Does nothing at the moment.</p>
</section>
<section id="id6">
<h4><span class="section-number">3.2.3.5.7. </span>connected<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h4>
<p>Called when a FE is connected.</p>
<p>Does nothing at the moment.</p>
</section>
<section id="reconfigured">
<h4><span class="section-number">3.2.3.5.8. </span>reconfigured<a class="headerlink" href="#reconfigured" title="Link to this heading">¶</a></h4>
<p>Called when a FE is reconfigured.</p>
<p>It does the following:</p>
<ul class="simple">
<li><p>Allocate and initialize the rings used by the reconfigured FE.</p></li>
<li><p>Bind the event channels (evtchn) to their corresponding virq callbacks.</p></li>
</ul>
</section>
<section id="close">
<h4><span class="section-number">3.2.3.5.9. </span>close<a class="headerlink" href="#close" title="Link to this heading">¶</a></h4>
<p>Called when a FE is closed.</p>
<p>It does the following:</p>
<ul class="simple">
<li><p>Deallocates and deinitializes the rings used by the closed FE.</p></li>
<li><p>Unmap and unbind the event channels.</p></li>
</ul>
</section>
</section>
<section id="external-interfaces">
<h3><span class="section-number">3.2.3.6. </span>External interfaces<a class="headerlink" href="#external-interfaces" title="Link to this heading">¶</a></h3>
<p>This section describes the interfaces from the BE point of view.</p>
<section id="interfacing-with-the-rfcomm-layer">
<h4><span class="section-number">3.2.3.6.1. </span>Interfacing with the RFCOMM layer<a class="headerlink" href="#interfacing-with-the-rfcomm-layer" title="Link to this heading">¶</a></h4>
<p>The <em>RFCOMM</em> driver is patched to be able to transmit the BT packets it receives to the <em>vuihandler</em>. In the same way, it has a custom function which allows it to be used by <em>SOOlink</em> when sending packets via BT.</p>
</section>
<section id="interfacing-with-the-me">
<h4><span class="section-number">3.2.3.6.2. </span>Interfacing with the ME<a class="headerlink" href="#interfacing-with-the-me" title="Link to this heading">¶</a></h4>
<p>The interfacing with the ME frontend is done using <em>VBStore</em>, shared buffers, rings and event channels.
The FE must provide a way to notify the BE through one of its event channel.</p>
<p>Once the notification arrives in the BE, it can then retrieve the data from the shared buffers and notify with a completion that a packet needs to be sent to the tablet or forwarded to the agency.</p>
<figure class="align-center" id="id9">
<img alt="../_images/SOO_drivers_vuihandler_FE_send.png" src="../_images/SOO_drivers_vuihandler_FE_send.png" />
<figcaption>
<p><span class="caption-number">Fig. 3.3 </span><span class="caption-text">Sequence diagram showing the FE sending a TX packet to the tablet, through the BE</span><a class="headerlink" href="#id9" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>The diagram above is a bit simplified as it doesn’t fully show the layers between the FE and the BE. You can refer the <a class="reference internal" href="../architecture/virt_interfaces/virt_interfaces.html#virt-interfaces"><span class="std std-ref">Virtualized Interfaces</span></a> document for more information about this layer.
It still shows the basic concept to send a packet from the ME to the tablet. As every sending/receiving are asynchronous, the <cite>vuihandler_send_fn</cite> (FE) and the <cite>tx_task_fn</cite> (BE) are running as threads and are notified once the data are ready to be sent.</p>
<figure class="align-center" id="id10">
<img alt="../_images/SOO_drivers_vuihandler_FE_recv.png" src="../_images/SOO_drivers_vuihandler_FE_recv.png" />
<figcaption>
<p><span class="caption-number">Fig. 3.4 </span><span class="caption-text">Sequence diagram showing the BE forwarding a packet coming from the tablet to a ME.</span><a class="headerlink" href="#id10" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>The diagram above is the RX path between the BE and FE. It follows the same idea as the TX path, using the ring to pass data between the BE and FE.
The ME routing is done using the their slotID, which is unique to each ME and is encoded in the <cite>vuihandler_pkt_t</cite> structure.</p>
</section>
<section id="interfacing-with-the-agency-modules">
<h4><span class="section-number">3.2.3.6.3. </span>Interfacing with the agency modules<a class="headerlink" href="#interfacing-with-the-agency-modules" title="Link to this heading">¶</a></h4>
<p>Another client from the <em>vuihandler</em> is the agency. It has multiple modules (injector, XML engine) which can ask the vuihandler to send data or which need to receive data from it.
The sending is done using the <cite>vuihandler_send_from_agency</cite> function, which will put the data in the circular TX buffer to be sent later on.</p>
<p>The data reception is a bit trickier, as we receive raw packets in the <em>vuihandler</em>. The packets are decoded and routed to the corresponding agency modules if needed, stripped from the <em>vuihandler</em> header.</p>
</section>
</section>
<section id="future-work-improvements">
<h3><span class="section-number">3.2.3.7. </span>Future work/Improvements<a class="headerlink" href="#future-work-improvements" title="Link to this heading">¶</a></h3>
<p>Below is a listing of the upgrades/ideas to refine and improve the <em>vuihandler</em>:</p>
<ul class="simple">
<li><p>The vUIHandler must act as a subscription, to which diverse clients could connect. The clients have a unique id which is used to route the incoming data.</p></li>
<li><p>The only process done by the vUIHandler, other than routing, is the direct forwarding to the ME. A special module could also be in charge to dispatch data to the MEs, to offload even more the processing outside vUIHandler.</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="vdummy.html" class="btn btn-neutral float-left" title="3.1. vdummy driver" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="vwagoled.html" class="btn btn-neutral float-right" title="3.3. vwagoled" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, HEIG-VD - REDS Institute.
      <span class="lastupdated">Last updated on 08 Jul 2024, 16:43.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>