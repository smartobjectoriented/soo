<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5. User Guide &mdash; Smart Object Oriented 2021.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/style.css" />
      <link rel="stylesheet" type="text/css" href="_static/theme_overrides.css?v=7751120a" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/documentation_options.js?v=b4aaf8b5"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="6. Logging facility" href="logging.html" />
    <link rel="prev" title="4.1. Agency user applications (usr)" href="rootfs/agency_usr.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Smart Object Oriented
          </a>
              <div class="version">
                2021.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture/architecture.html">2. SOO Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="drivers/drivers.html">3. Frontend &amp; backend drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="rootfs/rootfs.html">4. User applications and rootfs</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">5. User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pre-requisite">5.1. Pre-requisite</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#additional-packages">5.1.1. Additional packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#so3-git-submodule">5.1.2. SO3 Git submodule</a></li>
<li class="toctree-l3"><a class="reference internal" href="#toolchain">5.1.3. Toolchain</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#basic-components">5.2. Basic Components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#qemu">5.2.1. QEMU</a></li>
<li class="toctree-l3"><a class="reference internal" href="#trustzone-related-components">5.2.2. TrustZone Related Components</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#arm-trusted-firmware-trusted-firmware-a-also-known-as-atf">5.2.2.1. ARM Trusted firmware (trusted-firmware-a) also known as ATF</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#otee-os-open-trusted-execution-environment">5.2.3. OTEE_OS (Open Trusted Execution Environment)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#optee-ta-trusted-applications">5.2.3.1. OPTEE TA (Trusted Applications)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#u-boot">5.2.4. U-boot</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#soo-components">5.3. SOO Components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#agency">5.3.1. Agency</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#target-platforms">5.3.1.1. Target platforms</a></li>
<li class="toctree-l4"><a class="reference internal" href="#avz-hypervisor">5.3.1.2. AVZ Hypervisor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linux-kernel">5.3.1.3. Linux kernel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#main-root-filesystem-rootfs">5.3.1.4. Main root filesystem (<strong>rootfs</strong>)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initial-ramfs-initrd-filesystem">5.3.1.5. Initial ramfs (initrd) filesystem</a></li>
<li class="toctree-l4"><a class="reference internal" href="#agency-user-applications">5.3.1.6. Agency user applications</a></li>
<li class="toctree-l4"><a class="reference internal" href="#agency-filesystem">5.3.1.7. Agency filesystem</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deployment-into-the-storage-device">5.3.1.8. Deployment into the storage device</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#mobile-entity-me">5.3.2. Mobile Entity (ME)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#me-build">5.3.2.1. ME Build</a></li>
<li class="toctree-l4"><a class="reference internal" href="#me-build-script">5.3.2.2. ME build script</a></li>
<li class="toctree-l4"><a class="reference internal" href="#final-deployment">5.3.2.3. Final Deployment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#me-injection-from-the-agency">5.3.2.4. ME Injection from the Agency</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">6. Logging facility</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html#enabling-initcall-logging">7. Enabling <code class="docutils literal notranslate"><span class="pre">initcall</span></code> logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="board_issues.html">8. Board related issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="aarch64.html">9. Configuration for AArch64 64-bit architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_flow.html">10. Development  flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">11. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="ME/ME.html">12. Mobile Entities</a></li>
<li class="toctree-l1"><a class="reference internal" href="demos/demos.html">13. Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding_conventions.html">14. Coding conventions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Smart Object Oriented</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">5. </span>User Guide</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="user-guide">
<span id="id1"></span><h1><span class="section-number">5. </span>User Guide<a class="headerlink" href="#user-guide" title="Link to this heading">¶</a></h1>
<p>The installation should work in any Ubuntu/Kubuntu installation superior
to <code class="docutils literal notranslate"><span class="pre">16.10</span></code>. It is assumed that you are running an x86_64 version.</p>
<p>The following setup prepares to run the SOO framework in a QEMU-based
emulated environment. There is a file called <strong>build.conf</strong> in the
<em>agency/</em> directory which specifies the target platform. After a fresh
clone, build.conf is configured for QEMU <em>virt32</em> platform.</p>
<p>Additionally, the <em>virt32</em> target is also configured with TrustZone
support.</p>
<section id="pre-requisite">
<h2><span class="section-number">5.1. </span>Pre-requisite<a class="headerlink" href="#pre-requisite" title="Link to this heading">¶</a></h2>
<section id="additional-packages">
<h3><span class="section-number">5.1.1. </span>Additional packages<a class="headerlink" href="#additional-packages" title="Link to this heading">¶</a></h3>
<p>We need to run some i386 executables, and we need to install some i386
libraries too.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>dpkg<span class="w"> </span>--add-architecture<span class="w"> </span>i386
sudo<span class="w"> </span>apt-get<span class="w"> </span>update
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>libc6:i386<span class="w"> </span>libncurses5:i386<span class="w"> </span>libstdc++6:i386
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>lib32z1-dev
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>zlib1g:i386
</pre></div>
</div>
<p>Various other packages are required:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>pkg-config<span class="w"> </span>libgtk2.0-dev<span class="w"> </span>bridge-utils
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>unzip<span class="w"> </span>bc
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>elfutils<span class="w"> </span>u-boot-tools
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>device-tree-compiler
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>fdisk
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>libncurses-dev
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>libssl-dev<span class="w"> </span>openssl
</pre></div>
</div>
<p>The OP-TEE environment requires the following python packages:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip3<span class="w"> </span>install<span class="w"> </span>pycryptodome
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>python3-pyelftools
</pre></div>
</div>
<p>The following packets are not mandatory, but they can be installed to
prevent annoying warnings:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>bison<span class="w"> </span>flex
</pre></div>
</div>
</section>
<section id="so3-git-submodule">
<h3><span class="section-number">5.1.2. </span>SO3 Git submodule<a class="headerlink" href="#so3-git-submodule" title="Link to this heading">¶</a></h3>
<p>SO3 is used as hypervisor (AVZ) and for MEs. It is defined as a sub-module in
the main SOO repository.</p>
<p>To clone the submodule, do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>submodule<span class="w"> </span>update<span class="w"> </span>--init
</pre></div>
</div>
<p>Actually, the SO3 version for SOO includes additional files and a piece of modified
files specific to the SOO environment. A build script is used to create symbolic
links to original SO3 files as well as to SOO-related files stored in <code class="docutils literal notranslate"><span class="pre">ME/soo/so3</span></code>.</p>
<p>Go to the <code class="docutils literal notranslate"><span class="pre">ME/work</span></code> directory and execute the <code class="docutils literal notranslate"><span class="pre">build.sh</span></code> in order to build
the SOO specific SO3 environment.</p>
<p>It may take a while since the script create symlinks to all SO3 files.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not modify SO3 files which are not stored in <code class="docutils literal notranslate"><span class="pre">ME/soo/so3</span></code> since these
files come from the submodule. Go rather to Github SO3 page and make an issue
if modifications concern <em>standalone</em> SO3 or simply copy the original file
in <code class="docutils literal notranslate"><span class="pre">ME/soo/so3</span></code> to make changes which are SOO-specific.</p>
</div>
</section>
<section id="toolchain">
<h3><span class="section-number">5.1.3. </span>Toolchain<a class="headerlink" href="#toolchain" title="Link to this heading">¶</a></h3>
<p>The AArch-32 (ARM 32-bit) toolchain can be installed with the following commands:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/toolchains<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/opt/toolchains
<span class="c1"># Download and extract arm-none-linux-gnueabihf toolchain (gcc v11.3.1).</span>
$<span class="w"> </span>sudo<span class="w"> </span>wget<span class="w"> </span>https://snapshots.linaro.org/gnu-toolchain/11.3-2022.06-1/arm-linux-gnueabihf/gcc-linaro-11.3.1-2022.06-x86_64_arm-linux-gnueabihf.tar.xz
$<span class="w"> </span>sudo<span class="w"> </span>tar<span class="w"> </span>xf<span class="w"> </span>gcc-linaro-11.3.1-2022.06-x86_64_arm-linux-gnueabihf.tar.xz
$<span class="w"> </span>sudo<span class="w"> </span>rm<span class="w"> </span>gcc-linaro-11.3.1-2022.06-x86_64_arm-linux-gnueabihf.tar.xz
$<span class="w"> </span>sudo<span class="w"> </span>mv<span class="w"> </span>gcc-linaro-11.3.1-2022.06-x86_64_arm-linux-gnueabihf<span class="w"> </span>arm-linux-gnueabihf_11.3.1
$<span class="w"> </span>sudo<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;export PATH=&quot;${PATH}:/opt/toolchains/arm-linux-gnueabihf_11.3.1/bin&quot;&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/profile.d/02-toolchains.sh
</pre></div>
</div>
<p>For the 64-bit version (virt &amp; RPi4), the AArch-64 (ARM 64-bit) toolchain can be installed with the following commands:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/toolchains<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/opt/toolchains
<span class="c1"># Download and extract arm-none-linux-gnueabihf toolchain (gcc v10.2).</span>
$<span class="w"> </span>sudo<span class="w"> </span>wget<span class="w"> </span>https://developer.arm.com/-/media/Files/downloads/gnu/11.3.rel1/binrel/arm-gnu-toolchain-11.3.rel1-x86_64-aarch64-none-linux-gnu.tar.xz
$<span class="w"> </span>sudo<span class="w"> </span>tar<span class="w"> </span>xf<span class="w"> </span>arm-gnu-toolchain-11.3.rel1-x86_64-aarch64-none-linux-gnu.tar.xz
$<span class="w"> </span>sudo<span class="w"> </span>rm<span class="w"> </span>arm-gnu-toolchain-11.3.rel1-x86_64-aarch64-none-linux-gnu.tar.xz
$<span class="w"> </span>sudo<span class="w"> </span>mv<span class="w"> </span>arm-gnu-toolchain-11.3.rel1-x86_64-aarch64-none-linux-gnu<span class="w"> </span>aarch64-none-linux-gnu_11.3
$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;export PATH=&quot;${PATH}:/opt/toolchains/aarch64-none-linux-gnu_11.3/bin&quot;&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/profile.d/02-toolchains.sh
</pre></div>
</div>
</section>
</section>
<section id="basic-components">
<h2><span class="section-number">5.2. </span>Basic Components<a class="headerlink" href="#basic-components" title="Link to this heading">¶</a></h2>
<p>Currently, the framework contains all what is required to get a full
functional environment. It includes the QEMU emulator, ARM TrustZone
components, U-boot bootlader, etc.</p>
<section id="qemu">
<h3><span class="section-number">5.2.1. </span>QEMU<a class="headerlink" href="#qemu" title="Link to this heading">¶</a></h3>
<p>QEMU is in version 8.0.0. The source code is fetched and patched in order
to have framebuffer and mouse/keyboard support with the <code class="docutils literal notranslate"><span class="pre">virt</span></code> machine.</p>
<p>To fetch, patch and build QEMU, execute the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>qemu/
./fetch.sh
./configure<span class="w"> </span>--target-list<span class="o">=</span>arm-softmmu,aarch64-softmmu<span class="w"> </span>--disable-attr<span class="w"> </span>--disable-werror<span class="w"> </span>--disable-docs
make<span class="w"> </span>-j<span class="w"> </span><span class="k">$(</span>nproc<span class="k">)</span>
</pre></div>
</div>
<p>It may take some time, be patient! It builds QEMU to support both virt32 and virt64 platforms as defined
in the SOO environment.</p>
</section>
<section id="trustzone-related-components">
<h3><span class="section-number">5.2.2. </span>TrustZone Related Components<a class="headerlink" href="#trustzone-related-components" title="Link to this heading">¶</a></h3>
<p>Since the SOO agency relies on TrustZone for security concerns, it is
necessary to compile the trusted-firmware-a package as follows:</p>
<section id="arm-trusted-firmware-trusted-firmware-a-also-known-as-atf">
<h4><span class="section-number">5.2.2.1. </span>ARM Trusted firmware (trusted-firmware-a) also known as ATF<a class="headerlink" href="#arm-trusted-firmware-trusted-firmware-a-also-known-as-atf" title="Link to this heading">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>trusted-firmware-a
./build.sh
</pre></div>
</div>
</section>
</section>
<section id="otee-os-open-trusted-execution-environment">
<h3><span class="section-number">5.2.3. </span>OTEE_OS (Open Trusted Execution Environment)<a class="headerlink" href="#otee-os-open-trusted-execution-environment" title="Link to this heading">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>optee_os
./build.sh
</pre></div>
</div>
<section id="optee-ta-trusted-applications">
<h4><span class="section-number">5.2.3.1. </span>OPTEE TA (Trusted Applications)<a class="headerlink" href="#optee-ta-trusted-applications" title="Link to this heading">¶</a></h4>
<p>The <em>optee_ta/</em> directory contains our trusted applications used to
cipher/uncipher the ME, discovery beacons, etc.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>optee_ta
./build.sh
</pre></div>
</div>
</section>
</section>
<section id="u-boot">
<h3><span class="section-number">5.2.4. </span>U-boot<a class="headerlink" href="#u-boot" title="Link to this heading">¶</a></h3>
<p>The bootloader used by SOO is <strong>U-boot</strong>. In the sub-directory, there
are also various environment files used by the bootloader.</p>
<p>From 2019, the build system of agency and MEs is strongly based upon
U-boot ITB binary files which contain all necessary components. Not only
the SOO Agency is entirely contained in an ITB file, but also the Mobile
Entities (MEs) which are produced as that.</p>
<p>The compilation of <em>U-boot</em> is done with the following config and
commands (from the soo directory):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>u-boot
make<span class="w"> </span>virt32_defconfig
make<span class="w"> </span>-j8
</pre></div>
</div>
<p>The following configurations are available:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Platform</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><em>virt32_defconfig</em></p></td>
<td><p>Basic QEMU/virt 32-bit platform</p></td>
</tr>
<tr class="row-odd"><td><p><em>virt64_defconfig</em></p></td>
<td><p>QEMU/virt 64-bit platform</p></td>
</tr>
<tr class="row-even"><td><p><em>rpi_4_32b_defconfig</em></p></td>
<td><p>Raspberry Pi 4 in 32-bit mode</p></td>
</tr>
<tr class="row-odd"><td><p><em>rpi4_64_defconfig</em></p></td>
<td><p>Raspberry Pi 4 in 64-bit mode</p></td>
</tr>
<tr class="row-even"><td><p><em>cm4_64_defconfig</em></p></td>
<td><p>Raspberry Pi / CM4 module in 64-bit mode</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="soo-components">
<h2><span class="section-number">5.3. </span>SOO Components<a class="headerlink" href="#soo-components" title="Link to this heading">¶</a></h2>
<section id="agency">
<h3><span class="section-number">5.3.1. </span>Agency<a class="headerlink" href="#agency" title="Link to this heading">¶</a></h3>
<p>This section presents the different components which are required to be
built in the <strong>agency/</strong> directory. Different configurations are possible.</p>
<section id="target-platforms">
<h4><span class="section-number">5.3.1.1. </span>Target platforms<a class="headerlink" href="#target-platforms" title="Link to this heading">¶</a></h4>
<p>The file <code class="docutils literal notranslate"><span class="pre">build.conf</span></code> in the root directory contains the <code class="docutils literal notranslate"><span class="pre">PLATFORM</span></code> to select the target platform.</p>
<p>Possible platforms and types are:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Platform</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><em>virt32</em></p></td>
<td><p>Basic QEMU/virt 32-bit platform</p></td>
</tr>
<tr class="row-odd"><td><p><em>virt64</em></p></td>
<td><p>QEMU/virt 64-bit platform</p></td>
</tr>
<tr class="row-even"><td><p><em>rpi4</em></p></td>
<td><p>Raspberry Pi 4 in 32-bit mode</p></td>
</tr>
<tr class="row-odd"><td><p><em>rpi4_64</em></p></td>
<td><p>Raspberry Pi 4 in 64-bit mode</p></td>
</tr>
<tr class="row-even"><td><p><em>cm4_64</em></p></td>
<td><p>Raspberry Pi / CM4 module in 64-bit mode</p></td>
</tr>
</tbody>
</table>
</section>
<section id="avz-hypervisor">
<h4><span class="section-number">5.3.1.2. </span>AVZ Hypervisor<a class="headerlink" href="#avz-hypervisor" title="Link to this heading">¶</a></h4>
<p>Since <code class="docutils literal notranslate"><span class="pre">avz</span></code> is based on SO3, it will be compiled from the source available
in <code class="docutils literal notranslate"><span class="pre">so3/so3</span></code> thanks to the <code class="docutils literal notranslate"><span class="pre">./build.sh</span></code> script availabe in <em>avz</em> directory.</p>
<p>Building avz first requires to prepare the configuration as the following example for the <em>virt64</em> platform:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>avz
~/avz$<span class="w"> </span>./build.sh<span class="w"> </span>virt64_avz_pv_soo_defconfig
<span class="sb">`</span>/avz$<span class="w"> </span>./build.sh
</pre></div>
</div>
<p>In this example, the hypervisor is configured to support paravirtualized SOO enabled guest.</p>
<p>Executing the script without argument leads to a full build of avz.</p>
<p>To clean the avz directory properly, the <code class="docutils literal notranslate"><span class="pre">-c</span></code> option is availabe:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/avz$<span class="w"> </span>./build.sh<span class="w"> </span>-c
</pre></div>
</div>
</section>
<section id="linux-kernel">
<h4><span class="section-number">5.3.1.3. </span>Linux kernel<a class="headerlink" href="#linux-kernel" title="Link to this heading">¶</a></h4>
<p>To build the Linux kernel of the Agency, move to the kernel root directory <code class="docutils literal notranslate"><span class="pre">linux/linux</span></code>.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">make</span></code> is the simplest way to build the kernel after configuring adequatly, as example
for the <em>virt64</em> platform:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-j20</span></code> option assumes you can use 20 CPU cores to make the build with parallel execution.</p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>linux/linux
~/linux/linux$<span class="w"> </span>make<span class="w"> </span>virt64_defconfig
~/linux/linux$<span class="w"> </span>make<span class="w"> </span>-j20
</pre></div>
</div>
</section>
<section id="main-root-filesystem-rootfs">
<h4><span class="section-number">5.3.1.4. </span>Main root filesystem (<strong>rootfs</strong>)<a class="headerlink" href="#main-root-filesystem-rootfs" title="Link to this heading">¶</a></h4>
<p>In the code below, you have to replace <code class="docutils literal notranslate"><span class="pre">MYARCH</span></code> with the selected architecture.
All available configurations (*_defconfig) are placed in
the <code class="docutils literal notranslate"><span class="pre">configs/</span></code> directory.</p>
<ul class="simple">
<li><p>If the chosen architecture is <code class="docutils literal notranslate"><span class="pre">virt32</span></code>, <em>MYARCH</em> should be <em>virt32</em>.</p></li>
<li><p>If the chosen architecture is <code class="docutils literal notranslate"><span class="pre">Raspberry</span> <span class="pre">Pi</span> <span class="pre">4</span></code>: <em>MYARCH</em> should be <em>rpi4</em> .</p></li>
<li><p>etc.</p></li>
</ul>
<p>The following commands first retrieve all packages in a first step, then it compiles everything.
It may take quite a long time… Be patient!</p>
<p>From the agency’s directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>linux/rootfs
make<span class="w"> </span>MYARCH_defconfig
make<span class="w"> </span><span class="nb">source</span>
make
</pre></div>
</div>
</section>
<section id="initial-ramfs-initrd-filesystem">
<h4><span class="section-number">5.3.1.5. </span>Initial ramfs (initrd) filesystem<a class="headerlink" href="#initial-ramfs-initrd-filesystem" title="Link to this heading">¶</a></h4>
<p>In the agency, there is an <code class="docutils literal notranslate"><span class="pre">initrd</span></code> filesystem which is embedded in
the <em>ITB</em> image file. In order to access the content of this <em>initrd</em>,
a script in <code class="docutils literal notranslate"><span class="pre">agency/rootfs</span></code> is available. For example, to access
the content of the <em>virt32</em> board:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>linux/rootfs
./mount_initrd.sh<span class="w"> </span>virt32
<span class="nb">cd</span><span class="w"> </span>fs
</pre></div>
</div>
<p>Unmounting the filesystem is done with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>linux/rootfs
./umount_initrd.sh<span class="w"> </span>virt32
</pre></div>
</div>
</section>
<section id="agency-user-applications">
<h4><span class="section-number">5.3.1.6. </span>Agency user applications<a class="headerlink" href="#agency-user-applications" title="Link to this heading">¶</a></h4>
<p>In addition to the <code class="docutils literal notranslate"><span class="pre">rootfs</span></code>, the Agency has its own applications that
can be found in <code class="docutils literal notranslate"><span class="pre">linux/usr</span></code>. The build system of this part relies on
CMake. The build is achieved with the following script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">linux</span><span class="o">/</span><span class="n">usr</span>
<span class="o">./</span><span class="n">build</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</section>
<section id="agency-filesystem">
<h4><span class="section-number">5.3.1.7. </span>Agency filesystem<a class="headerlink" href="#agency-filesystem" title="Link to this heading">¶</a></h4>
<p>Once all main Agency components have been built, they will be put in a
virtual disk image as it is possible to attach such a virtual SD-Card
storage device with QEMU). The virtual storage is created in
<code class="docutils literal notranslate"><span class="pre">filesystem/</span></code> directory and will contain all the necessary partitions.</p>
<p>The creation of the virtual disk image is done as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>filesystem
./create_img.sh<span class="w"> </span>virt32
</pre></div>
</div>
</section>
<section id="deployment-into-the-storage-device">
<h4><span class="section-number">5.3.1.8. </span>Deployment into the storage device<a class="headerlink" href="#deployment-into-the-storage-device" title="Link to this heading">¶</a></h4>
<p>Finally, the deployment of all Agency components (including the
bootloader in some configurations) is achieved with the following script
(option <code class="docutils literal notranslate"><span class="pre">-a</span></code> for all) located at the root directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./deploy.sh<span class="w"> </span>-a
</pre></div>
</div>
<p>The script has different options (try simply <code class="docutils literal notranslate"><span class="pre">./deploy.sh</span></code> to get all
options).</p>
<p>Yeahhh!… Now it is time to make a try by launching the SOO Agency with
the following script, in the <code class="docutils literal notranslate"><span class="pre">root/</span></code> directory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./st
</pre></div>
</div>
<p>The script will launch QEMU with the correct options and the Agency
should start with the AVZ hypervisor and the Linux environment. You
should get a prompt entitled:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="sb">`</span>agency<span class="w"> </span>~<span class="w"> </span><span class="c1">#`</span>
</pre></div>
</div>
</section>
</section>
<section id="mobile-entity-me">
<h3><span class="section-number">5.3.2. </span>Mobile Entity (ME)<a class="headerlink" href="#mobile-entity-me" title="Link to this heading">¶</a></h3>
<p>For a quick test, it is proposed to build and to deploy the SOO.refso3
reference Mobile Entity.</p>
<section id="me-build">
<h4><span class="section-number">5.3.2.1. </span>ME Build<a class="headerlink" href="#me-build" title="Link to this heading">¶</a></h4>
<p>The main <code class="docutils literal notranslate"><span class="pre">ME</span></code>directory is amazingly <code class="docutils literal notranslate"><span class="pre">ME</span></code> at the root. However,
the source code is located in <code class="docutils literal notranslate"><span class="pre">so3/</span></code> directory since it is based on
this operating system.</p>
<p>Basically, a ME is constituted of its kernel (based on SO3 Operating
System), a device tree and eventually a rootfs used as <strong>ramfs</strong> (the
rootfs is embedded in the ME image itself, hence the ITB file).</p>
</section>
<section id="me-build-script">
<h4><span class="section-number">5.3.2.2. </span>ME build script<a class="headerlink" href="#me-build-script" title="Link to this heading">¶</a></h4>
<p>The ME can be build using the build.sh script found in <code class="docutils literal notranslate"><span class="pre">ME</span></code> directory.
This script takes 3 arguments 2 of which a mandatory and an optional one.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./build.sh

Build<span class="w"> </span>ME
Usage:<span class="w"> </span>./build.sh<span class="w"> </span>-OPTIONS<span class="w"> </span>&lt;ME_NAME&gt;<span class="w"> </span><span class="o">[</span>OPTIONAL_CONFIG<span class="o">]</span>
OPTIONS:
-k<span class="w">    </span>build<span class="w"> </span>kernel<span class="w"> </span>only
-u<span class="w">    </span>build<span class="w"> </span>user<span class="w"> </span>apps<span class="w"> </span>only
-ku<span class="w">   </span>build<span class="w"> </span>kernel<span class="w"> </span>and<span class="w"> </span>apps

Clean<span class="w"> </span>ME
Usage:<span class="w"> </span>./build.sh<span class="w"> </span>-c<span class="w"> </span>&lt;ME_NAME&gt;<span class="w"> </span>&lt;OTPIONAL_CONFIG&gt;

ME_NAME<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>one<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>following:
-<span class="w"> </span>SOO.agency
-<span class="w"> </span>SOO.blind
-<span class="w"> </span>SOO.ledctrl
-<span class="w"> </span>SOO.net
-<span class="w"> </span>SOO.outdoor
-<span class="w"> </span>SOO.refso3
-<span class="w"> </span>SOO.wagoled

OPTIONAL_CONFIG<span class="w"> </span>can<span class="w"> </span>be<span class="w"> </span>one<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>following:
-<span class="w"> </span>refso3_ramfs

Examples:
./build.sh<span class="w"> </span>-k<span class="w"> </span>SOO.refso3
./build.sh<span class="w"> </span>-ku<span class="w"> </span>SOO.refso3<span class="w"> </span>refso3_ramfs
</pre></div>
</div>
<ul class="simple">
<li><p>The OPTIONS argument allow you to build just the kernel <code class="docutils literal notranslate"><span class="pre">-k</span></code>, just the user space <code class="docutils literal notranslate"><span class="pre">-u</span></code> or both <code class="docutils literal notranslate"><span class="pre">-ku</span></code>. The <code class="docutils literal notranslate"><span class="pre">-c</span></code> option clean up the build.</p></li>
<li><p>The ME_NAME argument allow you to select which ME you want too build. You must use the SOO.&lt;ME_NAME&gt; syntax.</p></li>
<li><p>The OPTIONAL_CONFIG allow you to select a specific config for an ME if more than one exist. See <cite>Examples</cite> above.</p></li>
</ul>
<p>The build output <cite>&lt;ME_NAME&gt;.itb</cite> will be put inside the <code class="docutils literal notranslate"><span class="pre">ME/SOO.&lt;ME_NAME&gt;</span></code> folder which will be created if it doesn’t already exists.</p>
</section>
<section id="final-deployment">
<h4><span class="section-number">5.3.2.3. </span>Final Deployment<a class="headerlink" href="#final-deployment" title="Link to this heading">¶</a></h4>
<p>To deploy the newly built ME in the third partition of (virtual) SD-card use the deploy.sh script found
in the root folder.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./deploy.sh<span class="w"> </span>-m<span class="w"> </span>SOO.&lt;ME_NAME&gt;
</pre></div>
</div>
</section>
<section id="me-injection-from-the-agency">
<h4><span class="section-number">5.3.2.4. </span>ME Injection from the Agency<a class="headerlink" href="#me-injection-from-the-agency" title="Link to this heading">¶</a></h4>
<p>It’s time to test the new ME in the running environment. To do that,
simply start the framework. The agency process which is started
automatically will inspect the contents of <code class="docutils literal notranslate"><span class="pre">/mnt/ME</span></code> directory and
load all available <code class="docutils literal notranslate"><span class="pre">itb</span></code> files.</p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="rootfs/agency_usr.html" class="btn btn-neutral float-left" title="4.1. Agency user applications (usr)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="logging.html" class="btn btn-neutral float-right" title="6. Logging facility" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, HEIG-VD - REDS Institute.
      <span class="lastupdated">Last updated on 08 Jul 2024, 16:43.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>